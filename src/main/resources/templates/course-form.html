<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">

<head>
	<title th:text="${edit} ? #{course.form.edit.course} : #{course.form.add.course}"></title>

	<link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.snow.css">
	<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>

	<th:block layout:fragment="content">
		<div class="d-flex justify-content-between theme-content-head">
			<div th:text="${edit} ? #{course.form.edit.course} : #{course.form.add.course}"></div>
		</div>
		<div class="bg-light border rounded-3 p-4 mb-4">
			<form autocomplete="off" id="course-form" th:action="${edit} ? @{/course/{id}/edit(id=${courseForm.id})} : @{/course/add}" th:object="${courseForm}" method="post">
				<input type="hidden" th:field="*{description}" id="course-description">

				<h5 th:text="#{course.form.title}" for="title" class="form-label"></h5>
				<div class="mb-4 p-2">
					<input type="text" class="form-control" id="title" th:field="*{title}" th:errorclass="is-invalid" aria-describedby="title-feedback">
					<div id="title-feedback" class="invalid-feedback" th:if="${#fields.hasErrors('title')}" th:errors="${courseForm.title}"></div>
					<div id="titleHelpBlock" class="form-text">
						<span th:text="#{course.form.title.description}"></span> <span th:text="#{form.required}" class="badge bg-light text-dark"></span>
					</div>
				</div>

				<h5 th:text="#{course.form.description}" for="description" class="form-label"></h5>
				<div class="mb-4 p-2">
					<div class="bg-body border rounded-2" id="description-editor"></div>
				</div>

				<h5 th:text="#{course.form.passcode}" for="passcode" class="form-label"></h5>
				<div class="mb-4 p-2">
					<div class="input-group">
						<input type="password" class="form-control" id="passcode" name="passcode" th:field="*{passcode}" aria-describedby="passVisibility">
						<button type="button" is="password-visibility" for="passcode" class="btn btn-outline-secondary" id="passVisibility" data-class-visible="bi-eye" data-class-hidden="bi-eye-slash"><i id="visibility-icon" class="bi bi-eye-slash"></i></button>
					</div>
					<div th:text="#{course.form.passcode.description}" id="pinHelpBlock" class="form-text"></div>
				</div>

				<h5 for="role-accordion" class="form-label" th:text="#{course.form.role.title}"></h5>
				<div class="mb-4 p-2" th:if="${canAlterPrivileges}">
					<div id="role-accordion" class="accordion">
						<div class="accordion-item" th:each="formRole,roleStat : ${courseForm.roles}">
							<input type="hidden" th:field="*{roles[__${roleStat.index}__].role}" th:value="${formRole.role}">

							<h2 class="accordion-header" th:id="heading + ${formRole.role.id}">
								<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" th:attr="data-bs-target='#collapse' + ${formRole.role.id}, aria-expanded=false" aria-controls="collapseOne" th:text="#{${formRole.role.descriptionKey}}"></button>
							</h2>
							<div th:id="collapse + ${formRole.role.id}" class="accordion-collapse collapse" th:attr="aria-labelledby='heading' + ${formRole.role.id}" data-bs-parent="#role-accordion">
								<div class="accordion-body">
									<div class="form-check form-switch" th:each="formPrivilege,privStat : ${formRole.privileges}">
										<input type="hidden" th:field="*{roles[__${roleStat.index}__].privileges[__${privStat.index}__].privilege}" th:value="${formPrivilege.privilege}">

										<input th:id="${formRole.role.id} + '-' + ${formPrivilege.privilege.id}" class="form-check-input privilegeCheck" type="checkbox" th:field="*{roles[__${roleStat.index}__].privileges[__${privStat.index}__].selected}" th:checked="${formPrivilege.selected}">
										<label th:for="${formRole.role.id} + '-' + ${formPrivilege.privilege.id}" class="form-check-label" th:text="#{${formPrivilege.privilege.descriptionKey}}"></label>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="courseRoleHelpBlock" class="form-text">
						<span th:text="#{course.form.role.description}"></span>
						<span th:text="#{course.form.role.owner.info}" class="badge bg-light text-dark"></span>
					</div>
				</div>

				<h5 th:text="#{course.form.manage.users.title}" class="form-label"></h5>
				<div class="mb-4 p-2" th:if="${canAlterPrivileges}">
					<label th:text="#{course.form.manage.users.description}" class="form-text d-block"></label>

					<div id="users" th:replace="course-form :: course-form-users('newUser', 'userRoles')">
					</div>
				</div>
				<div class="mt-3 col-12">
					<button th:text="${edit} ? #{course.form.update} : #{course.form.create}" type="submit" class="btn btn-outline-primary btn-sm"></button>
				</div>
			</form>
		</div>
	</th:block>

	<div th:fragment="course-form-users(newUser, userRoles)" id="users" th:object="${courseForm}">
		<input type="hidden" th:field="*{id}">

		<div class="d-flex flex-row mb-3">
			<input type="hidden" th:each="formUserRole,userRoleStat : *{__${userRoles}__}" th:field="*{__${userRoles}__[__${userRoleStat.index}__].role}" th:value="${formUserRole.role}">
			</input>

			<div class="pt-2 pr-2">
				<label th:text="#{course.form.manage.users.username}" for="username" class="form-label"></label>
				<input type="text" class="form-control form-control-sm" id="username" th:field="*{__${newUser}__.username}" th:errorclass="is-invalid" aria-describedby="user-feedback">
			</div>
			<div class="p-2">
				<label th:text="#{course.form.manage.users.role}" for="roleSelect" class="form-label"></label>
				<input type="hidden" th:each="formUserRole,userRoleStat : *{__${userRoles}__}" th:value="${formUserRole.role}">

				<select th:field="*{newUser.role}" class="form-select form-select-sm">
					<option th:each="formUserRole,userRoleStat : *{__${userRoles}__}" th:value="${formUserRole.role.id}"
						th:text="#{${formUserRole.role.descriptionKey}}">
					</option>
				</select>
			</div>
			<div class="p-2 d-flex align-items-end">
				<button th:text="#{course.form.add.user}" type="submit" name="addUser"
					class="btn btn-sm btn-outline-primary"></button>
			</div>
		</div>
		<div th:if="${#fields.hasAnyErrors()}" class="mb-3">
			<ul class="list-group">
				<li th:each="error : ${#fields.allErrors()}" th:text="${error}" class="list-group-item list-group-item-danger"></li>
			</ul>
		</div>

		<table class="table table-hover table-sm">
			<thead class="table-light">
				<tr>
					<th scope="col" class="w-25" th:text="#{course.form.manage.users.username}"></th>
					<th scope="col" class="w-50" th:text="#{course.form.manage.users.name}"></th>
					<th scope="col" class="w-25" th:text="#{course.form.manage.users.role}"></th>
					<th scope="col" class=""></th>
				</tr>
			</thead>
			<tbody th:unless="${#lists.isEmpty(courseForm.privilegedUsers)}">
				<tr th:each="privilegedUser,userStat : ${courseForm.privilegedUsers}">
					<input type="hidden" th:field="${courseForm.privilegedUsers[__${userStat.index}__].username}">
					<input type="hidden" th:field="${courseForm.privilegedUsers[__${userStat.index}__].firstName}">
					<input type="hidden" th:field="${courseForm.privilegedUsers[__${userStat.index}__].familyName}">
					<input type="hidden" th:field="${courseForm.privilegedUsers[__${userStat.index}__].role}">

					<td th:text="${privilegedUser.username}"></td>
					<td th:text="${not #strings.isEmpty(privilegedUser.firstName)} ? |${privilegedUser.firstName} ${privilegedUser.familyName}| : #{course.form.manage.users.name.not.found}"></td>
					<td th:text="#{${privilegedUser.role.descriptionKey}}"></td>
					<td>
						<button name="removeUser" th:value="${userStat.index}" class="btn btn-outline-danger btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" th:title="#{course.delete}">
							<i class="bi bi-trash3"></i>
						</button>
					</td>
				</tr>
			</tbody>
			<tbody th:if="${#lists.isEmpty(courseForm.privilegedUsers)}">
				<tr>
					<td colspan="4" class="text-center" th:text="#{course.form.manage.users.empty}"></td>
				</tr>
			</tbody>
		</table>

		<script>
			var courseForm = document.getElementById("course-form");
			var userRemoveButton = document.querySelector("button[name='removeUser']");

			function replaceItems(html) {
				// Replace the user-table with a new one returned by server.
				$('#users').replaceWith($(html));
			}

			$('button[name="addUser"]').click(function (event) {
				event.preventDefault();

				var entries = Object.fromEntries(new FormData(courseForm));
				entries.addUser = "";

				const data = new URLSearchParams(entries).toString();

				$.post('/course/add/user', data, replaceItems);
			});

			$("button[name='removeUser']").click(function (event) {
				event.preventDefault();

				var entries = Object.fromEntries(new FormData(courseForm));
				// Add parameter and index of item that is going to be removed.
				entries.removeUser = $(this).val();

				const data = new URLSearchParams(entries).toString();

				$.post('/course/remove/user', data, replaceItems);
			});
		</script>
	</div>

	<th:block layout:fragment="optional">
		<script>
			const form = document.getElementById("course-form");
			const description = document.getElementById("course-description");

			const quill = new Quill("#description-editor", {
				theme: "snow"
			});

			quill.root.innerHTML = description.value;

			form.onsubmit = function () {
				description.value = quill.root.innerHTML;
				return true;
			}
		</script>

		<style>
			.ql-toolbar.ql-snow {
				border: none;
				padding: 0 0 0.5em 0;
			}
		</style>
	</th:block>
</body>

</html>